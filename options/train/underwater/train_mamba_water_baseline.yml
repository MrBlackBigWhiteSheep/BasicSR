# GENERATE TIME: Tue Dec 30 11:26:49 2025
# CMD:
# basicsr/train.py -opt options/train/underwater/train_mambawater_1.yml

name: MambaWater_UIEB_enhance01018_2
model_type: MambaWaterModel
scale: 1
num_gpu: 2
manual_seed: 10

# dataset and data loader settings
datasets:
  train:
    task: Restoration
    name: UIEB
    type: PairedImageDataset
  dataroot_gt: /data/wa/dataset/low_vision_task/UIE/A_data_spil/UIEB_09/reference-800
  dataroot_lq: /data/wa/dataset/low_vision_task/UIE/A_data_spil/UIEB_09/raw-800
    filename_tmpl: '{}'
    io_backend:
      type: disk

    gt_size: 128
    use_hflip: true
    use_rot: true

    # data loader
    use_shuffle: true
    num_worker_per_gpu: 4
    batch_size_per_gpu: 6
    dataset_enlarge_ratio: 1
    prefetch_mode: ~

  val:
    name: UIEB
    type: PairedImageDataset
    dataroot_gt: /data/wa/dataset/low_vision_task/UIE/A_data_spil/UIEB_09/reference-90
    dataroot_lq: /data/wa/dataset/low_vision_task/UIE/A_data_spil/UIEB_09/raw-90
    filename_tmpl: '{}'
    io_backend:
      type: disk
    gt_size: 128

network_g:
  type: MambaWater
  upscale: 1
  in_chans: 3
  img_size: 128
  img_range: 1.

  embed_dim: 40        # ä¿æŒ 40
  d_state: 16
  depths: [2, 2, 2, 2]
  
  # === å¿…é¡»ä¿®æ”¹è¿™é‡Œ ===
  num_heads: [4, 4, 4, 4]  # 40 / 4 = 10 (æ•´é™¤ï¼ä¸ä¼šæŠ¥é”™)
  # num_heads: [6, 6, 6, 6] <--- è¿™æ˜¯æŠ¥é”™çš„åŸå› 
  
  window_size: 16
  inner_rank: 32
  num_tokens: 64
  convffn_kernel_size: 3
  mlp_ratio: 1.2
  
  upsampler: ~
  resi_connection: '1conv'

# path
path:
  pretrain_network_g: ~
  strict_load_g: true
  resume_state: ~

# training settings
train:
  use_amp: true   
  
  optim_g:
      type: AdamW             # ã€ä¿®æ”¹ã€‘æ¨èç”¨ AdamWï¼Œæ³›åŒ–èƒ½åŠ›æ›´å¼º
      lr: !!float 4e-4        # ã€å¾®è°ƒã€‘é…åˆ AdamW å’Œ Cosineï¼Œ4e-4 æ¯”è¾ƒç¨³
      weight_decay: !!float 1e-4
      betas: [0.9, 0.99]

  scheduler:
      type: CosineAnnealingRestartLR # ã€é‡è¦ä¿®æ”¹ã€‘SOTA æ ‡é…è°ƒåº¦å™¨
      periods: [300000]       # å‘¨æœŸä¸ total_iter ä¿æŒä¸€è‡´
      restart_weights: [1]
      eta_min: !!float 1e-7

  total_iter: 300000        # ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä» 20000 -> 300000ã€‚è¿™æ˜¯å‘è®ºæ–‡çš„é—¨æ§›ã€‚
  warmup_iter: -1           # Mamba æœ‰æ—¶å€™éœ€è¦é¢„çƒ­ï¼Œå¦‚æœå‰å‡ ç™¾æ¬¡lossç‚¸äº†ï¼Œè¿™é‡Œæ”¹æˆ 5000

  # losses
  pixel_opt:
    type: L1Loss
    loss_weight: 1.0

  ssim_opt:
    type: SSIMLoss
    loss_weight: 0.2
  
  # ã€æ–°å¢/ä¿®æ”¹ã€‘æ„ŸçŸ¥æŸå¤±é…ç½®
  perceptual_opt:
    type: PerceptualLoss
    # 1. layer_weights: å¯¹åº”ä»£ç ä¸­çš„ layer_weights å‚æ•°
    #    'conv5_4' æ˜¯ VGG19 è¾ƒæ·±å±‚ï¼Œå…³æ³¨è¯­ä¹‰å’Œæ•´ä½“ç»“æ„ï¼Œé€‚åˆå»é›¾/æ°´ä¸‹å¢å¼º
    layer_weights:
      'conv5_4': 1.0  
    
    # 2. vgg_type: å¯¹åº” vgg_typeï¼Œä¿æŒé»˜è®¤å³å¯
    vgg_type: vgg19
    
    # 3. use_input_norm: å¯¹åº” use_input_norm
    #    å¿…é¡»ä¸º trueã€‚VGG éœ€è¦å¯¹è¾“å…¥è¿›è¡Œ ImageNet çš„å‡å€¼/æ–¹å·®å½’ä¸€åŒ–
    use_input_norm: true
    
    # 4. range_norm: å¯¹åº” range_norm
    #    ã€å…³é”®ã€‘è®¾ä¸º falseã€‚
    #    ä½ çš„ datasets é…ç½®é‡Œ img_range æ˜¯ 1.0ï¼ˆå³ [0,1]ï¼‰ï¼Œä»£ç æ³¨é‡Šè¯´è¯¥å‚æ•°æ˜¯å°† [-1,1] è½¬ä¸º [0,1]ã€‚
    #    æ—¢ç„¶ä½ å·²ç»æ˜¯ [0,1]ï¼Œå°±ä¸éœ€è¦è½¬æ¢äº†ã€‚
    range_norm: false
    
    # 5. perceptual_weight: å¯¹åº” perceptual_weight
    #    æ„ŸçŸ¥æŸå¤±çš„æƒé‡ï¼Œé€šå¸¸è®¾ä¸º 1.0 æˆ– 0.1ï¼ˆè§†æ˜¾å­˜å’Œ L1 Loss çš„é‡çº§è€Œå®šï¼‰
    perceptual_weight: 1.0
    
    # 6. style_weight: å¯¹åº” style_weight
    #    é£æ ¼æŸå¤±æƒé‡ã€‚å¦‚æœä¸å¸Œæœ›å¼ºåˆ¶æ”¹å˜çº¹ç†é£æ ¼ï¼Œè®¾ä¸º 0ï¼›
    #    å¦‚æœæ°´ä¸‹åè‰²ä¸¥é‡éœ€è¦å¼ºåˆ¶çŸ«æ­£ï¼Œå¯ä»¥å°è¯•è®¾ä¸º 10.0 æˆ–æ›´é«˜
    style_weight: 0

    criterion: l1


# validation settings
val:
  val_freq: 500
  save_img: false

  metrics:
    psnr:
      type: calculate_psnr
      crop_border: 0
      test_y_channel: false
    ssim:
      type: calculate_ssim
      crop_border: 0
    # æ°´ä¸‹è‰²å½©è¡¡é‡æŒ‡æ ‡
    uiqm:
      type: calculate_uiqm
    uciqe:
      type: calculate_uciqe
    # ä¿¡æ¯å¢’
    entropy:
      type: calculate_entropy
    # æ„ŸçŸ¥ä¸è‡ªç„¶æŒ‡æ ‡  
    lpips:
      type: calculate_lpips
      net_type: vgg
      better: lower
    niqe:
        type: calculate_niqe
        crop_border: 0
        better: lower          # ğŸš¨ è¶Šä½è¶Šå¥½ï¼šè¶Šä½ä»£è¡¨è¶Šæ¥è¿‘â€œè‡ªç„¶å›¾åƒç»Ÿè®¡è§„å¾‹â€


# logging settings
logger:
  print_freq: 100
  save_checkpoint_freq: 500
  use_tb_logger: true
  wandb:
    project: ~
    resume_id: ~

# dist training settings
dist_params:
  backend: nccl
  port: 29500